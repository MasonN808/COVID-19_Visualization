<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Independent Farms by County - Choropleth</title>
	<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="https://d3js.org/queue.v1.min.js"></script>
	<script type="text/javascript" src="https://d3js.org/topojson.v1.min.js"></script>
	
	<!-- <script type="text/javascript" src="js/choropleth.js"></script> -->
	<!-- <script src="css/index.css"></script> -->
	<link href="css/index.css" rel="stylesheet" type="text/css" />
</head>



<body>
	<h1>A Visualization of the COVID-19 Pandemic</h1>
	<section>
		<h2>Aggregated Choropleth Map of US Counties from 2021-Present</h2>
		<p>In this demo we examine a data set from the 2003 National Assesssment of Adult Literacy. We were curious about adult literacy rates in our home state of New York, and decided to approach this by looking at the <em>prose literacy</em> rate across New York counties. We decided to include only the proportion of adults with <em>Below Basic</em> level prose literacy, and chose a color palette that highlights those counties with the highest illiteracy rates. Clicking on the chart will bring up additional details, which are updated as you hover over each county. Finally, you can switch to an alternate color palette that conveys for each county how it fares relative to the national prose illiteracy rate.</p>
		<figure id = "choroplethMap"></figure>
		<h3>Data Sources</h3>
		<ul>
		<li><cite><a href="https://nces.ed.gov/naal/estimates/StateEstimates.aspx">National Center for Education Statistics - State Estimates</a></cite></li>
		</ul>
		<script type="text/javascript">	
			var width = 960,
				height = 600;

			var color_domain = [1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000];

			var ext_color_domain = [1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000];

			var legend_labels = ["> 1000", '2000', '3000', '4000', '5000', '6000', '7000', '8000+'];
			// var legend_labels = ["< 500", "500+", "1000+", "1500+", "2000+", "2500+", "3000+", "3500+", "4000+", "4500+", "5000+", "5500+", "6000+"];

			var colorScale = d3.scale.threshold()
				.domain(color_domain)
				.range(['#fff7ec', '#fee8c8', '#fdd49e', '#fdbb84', '#fc8d59', '#ef6548', '#d7301f', '#990000']);
				
			var div = d3.select("#choroplethMap").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);
				
			var svg = d3.select("#choroplethMap").append("svg")
				.attr("width", width)
				.attr("height", height)
				.style("margin", "-15px auto");

			// var path = d3.geo.path().projection(null);
			var path = d3.geo.path();

			function ready(error, us, data) {
				if (error) throw error;
				
				var pairRateWithId = {};
				var pairNameWithId = {};

				//Moves selction to front
				d3.selection.prototype.moveToFront = function() {
					return this.each(function(){
					this.parentNode.appendChild(this);
					});
				}; 

				//Moves selction to back
				d3.selection.prototype.moveToBack = function() { 
					return this.each(function() { 
					var firstChild = this.parentNode.firstChild; 
					if (firstChild) { 
						this.parentNode.insertBefore(this, firstChild); 
					} 
					}); 
				};

				// console.log(us.objects.counties) //Debugging
				data.forEach(function(d) {
					if (pairRateWithId[d.fips_code] === undefined) { // add another condidtion stating that this is the first iteration
						pairRateWithId[d.fips_code] = 0 // This makes sure NaNs arent produced using += newCases
					}
					if (d.percent_test_results_reported_positive_last_7_days === undefined) {
						newCases = 0
						console.log(d.fips_code)
					}
					else {
						newCases = +d.percent_test_results_reported_positive_last_7_days
					}
					pairRateWithId[d.fips_code] += newCases; //TODO: change d.id to whatever it is in data.csv
					pairNameWithId[d.fips_code] = d.county_name;
					if (pairRateWithId[d.fips_code] === undefined) {
						console.error("ERROR: found undefined at", d.fips_code)
					}
					// console.log(d.fips_code) //Debugging
					})

				// Debugging
				// data.forEach(function(d) {
				//     console.log(d.fips_code)
				// 	// if (pairRateWithId[d.fips_code] === undefined) {
				// 	// 	console.error("ERROR: found undefined at", d.fips_code)
				// 	// }
				// });
				console.log("pairratewithid1", pairRateWithId[10001]);

				svg.append("g")
				.attr("class", "county")
				.selectAll("path")
				.data(topojson.feature(us, us.objects.counties).features)
				.enter().append("path")
				.attr("d", path)
				.style ( "fill" , function(d) {
					// d is the element in the us.json file so we use id to identify fips code
					d.total = pairRateWithId[d.id] || -1;
					return colorScale(d.total);
				})
				.style("opacity", 0.8)
				.on("mouseover", function(d) {
					var sel = d3.select(this);
					sel.moveToFront();
					d3.select(this).transition().duration(300).style({'opacity': 1, 'stroke': 'black', 'stroke-width': 1.5});

					div.transition().duration(300)
						.style("opacity", 1)
						// console.log("pairratewithid1", pairRateWithId);
						if (pairRateWithId[d.id] === undefined){
							numCases = "N/A"
						}
						else {
							numCases = pairRateWithId[d.id]
						}
						div.text(pairNameWithId[d.id] + ": " + Math.round(numCases))

						.style("left", (d3.event.pageX) + "px")
						.style("top", (d3.event.pageY -30) + "px");
				})
				.on("mouseout", function() {
					var sel = d3.select(this);
					sel.moveToBack();
					d3.select(this)
					.transition().duration(300)
					.style({'opacity': 0.8, 'stroke': 'white', 'stroke-width': 1});
					div.transition().duration(300)
					.style("opacity", 0);
				});
				console.log("pairratewithid2", pairRateWithId)
				// console.log(topojson.feature(us, us.objects.counties).features);
				//  svg.append("path")
				//  .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a.id / 1000 ^ b.id / 1000; }))
				//  .attr("class", "state-borders")
				//  .attr("d", path);
			};
			// const indexes = 1-ext_color_domain.length
			// ext_color_domain[indexes] = ext_color_domain[indexes]/2
			// for(var i = 1, length = ext_color_domain.length; i < length; i++){
			// 	ext_color_domain[i] /= 2;  // `a[i].x /= d` is shorthand for `a[i].x = a[i].x / d`
			// }
			console.log(ext_color_domain)
			var legend = svg.selectAll("g.legend")
				.data(ext_color_domain)
				.enter().append("g")
				.attr("class", "legend");
				
			var ls_w = 73, ls_h = 20;
				
			legend.append("rect")
				.attr("x", function(d, i){ return width - (i*ls_w) - ls_w;})
				.attr("y", 550)
				.attr("width", ls_w)
				.attr("height", ls_h)
				.style("fill", function(d, i) { return colorScale(d); })
				.style("opacity", 0.8);
				
			legend.append("text")
				.attr("x", function(d, i){ return width - (i*ls_w) - ls_w;})
				.attr("y", 590)
				.text(function(d, i){ return legend_labels[i]; });

			var legend_title = "Number of Covid Cases";

			svg.append("text")
				.attr("x", 10)
				.attr("y", 540)
				.attr("class", "legend_title")
				.text(function(){return legend_title});

			queue()
			.defer(d3.json, "counties-10m.json")
			.defer(d3.csv, "data.csv")
			.await(ready);
		</script>
	</section>
	<h1>Independent Farms in the USA</h1>
		 <script type="text/javascript">
		 
		</script>

<p>Source: U.S. Census</p>		
</body>

</html>